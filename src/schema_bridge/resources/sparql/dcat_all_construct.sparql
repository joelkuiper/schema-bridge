PREFIX ex: <https://catalogue.org/>
PREFIX field: <https://catalogue.org/field/>
PREFIX entity: <https://catalogue.org/entity/>
PREFIX dcat: <http://www.w3.org/ns/dcat#>
PREFIX dct: <http://purl.org/dc/terms/>
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
PREFIX vcard: <http://www.w3.org/2006/vcard/ns#>
PREFIX adms: <http://www.w3.org/ns/adms#>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX odrl: <http://www.w3.org/ns/odrl/2/>
PREFIX spdx: <http://spdx.org/rdf/terms#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

CONSTRUCT {
  ?res a dcat:Resource ;
       dct:identifier ?identifier ;
       dct:title ?title ;
       dct:description ?description ;
       dcat:landingPage ?homepageIri ;
       foaf:homepage ?homepageIri ;
       dcat:keyword ?keywordLiteral ;
       dcat:theme ?themeIri ;
       dcat:contactPoint ?contact ;
       dct:publisher ?publisher ;
       dct:creator ?creator ;
       dct:accessRights ?accessRightsValue ;
       dct:license ?licenseValue ;
       dct:rights ?rightsValue ;
       dct:conformsTo ?conformsToIri ;
       dct:relation ?relationIri ;
       dct:hasPart ?hasPartIri ;
       dct:isReferencedBy ?referenceIri ;
       dct:issued ?issuedValue ;
       dct:modified ?modifiedValue ;
       dct:type ?typeIri ;
       dcat:hasVersion ?hasVersionValue ;
       dcat:hasCurrentVersion ?hasCurrentVersionValue ;
       dcat:version ?versionValue ;
       dcat:previousVersion ?previousVersionValue ;
       dcat:first ?firstValue ;
       dcat:last ?lastValue ;
       dcat:prev ?prevValue ;
       dcat:qualifiedRelation ?qualifiedRelation ;
       odrl:hasPolicy ?hasPolicyValue ;
       prov:qualifiedAttribution ?attribution ;
       adms:status ?statusValue ;
       adms:versionNotes ?versionNotesValue ;
       dct:spatial ?spatialValue ;
       dct:temporal ?temporal .

  ?dataset a dcat:Dataset ;
           dcat:distribution ?distribution ;
           dcat:inSeries ?series ;
           dcat:spatialResolutionInMeters ?spatialResolutionInMeters ;
           dcat:temporalResolution ?temporalResolution ;
           dct:accrualPeriodicity ?accrualPeriodicity ;
           dct:spatial ?spatialValue ;
           dct:temporal ?temporal ;
           prov:wasGeneratedBy ?wasGeneratedBy .

  ?catalog a dcat:Catalog ;
           dcat:catalog ?catalogIri ;
           dcat:dataset ?catalogDataset ;
           dcat:record ?catalogRecord ;
           dcat:resource ?catalogResource ;
           dcat:service ?catalogService ;
           dcat:themeTaxonomy ?themeTaxonomy ;
           foaf:homepage ?homepageIri ;
           dcat:distribution ?distribution ;
           dcat:inSeries ?series ;
           dcat:spatialResolutionInMeters ?spatialResolutionInMeters ;
           dcat:temporalResolution ?temporalResolution ;
           dct:accrualPeriodicity ?accrualPeriodicity ;
           dct:spatial ?spatialValue ;
           dct:temporal ?temporal ;
           prov:wasGeneratedBy ?wasGeneratedBy .

  ?service a dcat:DataService ;
           dcat:endpointURL ?endpointUrlIri ;
           dcat:endpointDescription ?endpointDescriptionIri ;
           dcat:servesDataset ?servesDataset ;
           dcat:contactPoint ?contact ;
           dct:publisher ?publisher .

  ?distribution a dcat:Distribution ;
                dcat:accessService ?accessService ;
                dcat:accessURL ?accessUrlIri ;
                dcat:downloadURL ?downloadUrlIri ;
                dcat:byteSize ?byteSize ;
                dcat:compressFormat ?compressFormatIri ;
                dcat:mediaType ?mediaTypeIri ;
                dcat:packageFormat ?packageFormatIri ;
                dcat:spatialResolutionInMeters ?spatialResolutionInMeters ;
                dcat:temporalResolution ?temporalResolution ;
                dct:accessRights ?accessRightsValue ;
                dct:conformsTo ?conformsToIri ;
                dct:description ?distributionDescription ;
                dct:format ?formatIri ;
                dct:issued ?distributionIssued ;
                dct:license ?licenseValue ;
                dct:modified ?distributionModified ;
                dct:rights ?rightsValue ;
                dct:title ?distributionTitle ;
                odrl:hasPolicy ?hasPolicyValue ;
                spdx:checksum ?checksumValue ;
                dcat:version ?distributionVersion .

  ?series a dcat:DatasetSeries .

  ?record a dcat:CatalogRecord ;
          dct:conformsTo ?conformsToIri ;
          dct:description ?recordDescription ;
          dct:issued ?recordIssued ;
          dct:modified ?recordModified ;
          dct:title ?recordTitle ;
          foaf:primaryTopic ?recordTopic .

  ?relationship a dcat:Relationship ;
                dcat:hadRole ?relationshipRole ;
                dct:relation ?relationshipRelation .

  ?contact a vcard:Individual ;
           vcard:fn ?contactName ;
           vcard:hasEmail ?contactEmailIri .

  ?publisher a foaf:Organization ;
             foaf:name ?publisherName ;
             foaf:homepage ?publisherHomepageIri .

  ?temporal a dct:PeriodOfTime ;
            dcat:startDate ?startDateValue ;
            dcat:endDate ?endDateValue .

  ?qualifiedRelation a dcat:Relationship ;
                     dct:relation ?qualifiedRelationTarget ;
                     dcat:hadRole ?qualifiedRelationRole .

  ?attribution a prov:Attribution ;
               prov:agent ?attributionAgent ;
               prov:hadRole ?attributionRole ;
               dct:description ?attributionDescription .

  ?attributionAgent a prov:Agent ;
                    foaf:name ?attributionAgentName .
}
WHERE {
  ?res a entity:Resource .

  OPTIONAL { ?res field:acronym ?identifier . }
  OPTIONAL { ?res field:name ?title . }
  OPTIONAL { ?res field:description ?description . }
  OPTIONAL {
    ?res field:homepage ?homepage .
    BIND(IRI(STR(?homepage)) AS ?homepageIri)
  }

  OPTIONAL { ?res field:keywordNames ?keywordLiteral . }
  OPTIONAL {
    ?res field:keywordUris ?keywordUri .
    BIND(IRI(STR(?keywordUri)) AS ?themeIri)
  }
  OPTIONAL {
    ?res field:keywordConcept ?keywordConcept .
    OPTIONAL { ?keywordConcept skos:prefLabel ?keywordConceptLabel . }
    FILTER(!BOUND(?keywordLiteral))
    BIND(?keywordConceptLabel AS ?keywordLiteral)
  }
  OPTIONAL {
    ?res field:keywordConcept ?keywordConcept .
    BIND(?keywordConcept AS ?themeIri)
  }

  OPTIONAL { ?res field:typeUris ?typeUri . BIND(IRI(STR(?typeUri)) AS ?typeIri) }
  OPTIONAL { ?res field:typeConcept ?typeConcept . BIND(?typeConcept AS ?typeIri) }

  OPTIONAL {
    ?res field:contactEmails ?contactEmail .
    BIND(IRI(CONCAT("mailto:", STR(?contactEmail))) AS ?contactEmailIri)
    BIND(IRI(CONCAT("https://catalogue.org/contact/", ENCODE_FOR_URI(STR(?contactEmail)))) AS ?contact)
  }
  OPTIONAL { ?res field:contactNames ?contactName . }

  OPTIONAL {
    ?res field:institutionNames ?publisherName .
    BIND(IRI(CONCAT("https://catalogue.org/org/", ENCODE_FOR_URI(STR(?publisherName)))) AS ?publisher)
  }
  OPTIONAL {
    ?res field:institutionHomepages ?publisherHomepage .
    BIND(IRI(STR(?publisherHomepage)) AS ?publisherHomepageIri)
  }

  OPTIONAL {
    ?res field:conditionUris ?accessRights .
    BIND(IRI(STR(?accessRights)) AS ?accessRightsValue)
  }
  OPTIONAL { ?res field:accessRightsConcept ?accessRightsConcept . BIND(?accessRightsConcept AS ?accessRightsValue) }
  OPTIONAL {
    ?res field:conditionsDescription ?licenseValue .
  }
  OPTIONAL { ?res field:rights ?rightsValue . }

  OPTIONAL {
    ?res field:populationUris ?populationUri .
    BIND(IRI(STR(?populationUri)) AS ?spatialValue)
  }
  OPTIONAL { ?res field:spatialConcept ?spatialConcept . BIND(?spatialConcept AS ?spatialValue) }
  OPTIONAL { ?res field:populationNames ?spatialValue . }

  OPTIONAL { ?res field:distribution ?distribution . }
  OPTIONAL {
    ?res field:releaseIds ?releaseId .
    BIND(IRI(CONCAT("https://catalogue.org/distribution/", ENCODE_FOR_URI(STR(?releaseId)))) AS ?distribution)
  }

  OPTIONAL { ?distribution field:releaseDate ?distributionIssued . }
  OPTIONAL { ?distribution field:releaseDescription ?distributionDescription . }
  OPTIONAL {
    ?distribution field:releaseVersion ?releaseVersion .
    BIND(STR(?releaseVersion) AS ?distributionTitle)
    BIND(STR(?releaseVersion) AS ?distributionVersion)
    BIND(STR(?releaseVersion) AS ?versionValue)
  }

  OPTIONAL {
    ?res field:documentationUrls ?documentationUrl .
    BIND(IRI(STR(?documentationUrl)) AS ?accessUrlIri)
    BIND(IRI(STR(?documentationUrl)) AS ?endpointDescriptionIri)
  }
  OPTIONAL { ?res field:documentationTitles ?recordTitle . }
  OPTIONAL { ?res field:documentationDescriptions ?recordDescription . }

  OPTIONAL { ?res field:inclusionCriteriaUris ?conformsToUri . BIND(IRI(STR(?conformsToUri)) AS ?conformsToIri) }
  OPTIONAL { ?res field:conformsToConcept ?conformsToConcept . BIND(?conformsToConcept AS ?conformsToIri) }

  OPTIONAL { ?res field:publicationUrls ?referenceUrl . BIND(IRI(STR(?referenceUrl)) AS ?referenceIri) }
  OPTIONAL { ?res field:publicationDois ?referenceDoi . BIND(IRI(CONCAT("https://doi.org/", STR(?referenceDoi))) AS ?referenceIri) }

  OPTIONAL {
    ?res field:startYear ?startYear .
    BIND(STRDT(STR(?startYear), xsd:gYear) AS ?startDateValue)
  }
  OPTIONAL {
    ?res field:endYear ?endYear .
    BIND(STRDT(STR(?endYear), xsd:gYear) AS ?endDateValue)
  }
  OPTIONAL {
    FILTER(BOUND(?startDateValue) || BOUND(?endDateValue))
    BIND(BNODE() AS ?temporal)
  }

  OPTIONAL { ?res field:issued ?issuedValue . }
  OPTIONAL { ?res field:modified ?modifiedValue . }

  OPTIONAL { ?res field:spatialResolutionInMeters ?spatialResolutionInMeters . }
  OPTIONAL { ?res field:temporalResolution ?temporalResolution . }
  OPTIONAL { ?res field:accrualPeriodicity ?accrualPeriodicity . }

  OPTIONAL { ?res field:relation ?relationRaw . BIND(IRI(STR(?relationRaw)) AS ?relationIri) }
  OPTIONAL { ?res field:hasPart ?hasPartRaw . BIND(IRI(STR(?hasPartRaw)) AS ?hasPartIri) }

  OPTIONAL { ?res field:hasVersion ?hasVersionValue . }
  OPTIONAL { ?res field:hasCurrentVersion ?hasCurrentVersionValue . }
  OPTIONAL { ?res field:previousVersion ?previousVersionValue . }
  OPTIONAL { ?res field:first ?firstValue . }
  OPTIONAL { ?res field:last ?lastValue . }
  OPTIONAL { ?res field:prev ?prevValue . }
  OPTIONAL { ?res field:hasPolicy ?hasPolicyValue . }
  OPTIONAL { ?res field:status ?statusValue . }
  OPTIONAL { ?res field:versionNotes ?versionNotesValue . }

  OPTIONAL { ?res field:partnerInstitutionNames ?creatorName . BIND(IRI(CONCAT("https://catalogue.org/org/", ENCODE_FOR_URI(STR(?creatorName)))) AS ?creator) }

  OPTIONAL {
    ?res field:partnerRoleUris ?partnerRoleUri .
    BIND(IRI(STR(?partnerRoleUri)) AS ?qualifiedRelationRole)
  }
  OPTIONAL {
    ?res field:partnerInstitutionNames ?partnerInstitutionName .
    BIND(IRI(CONCAT("https://catalogue.org/org/", ENCODE_FOR_URI(STR(?partnerInstitutionName)))) AS ?qualifiedRelationTarget)
  }
  OPTIONAL {
    FILTER(BOUND(?qualifiedRelationTarget) || BOUND(?qualifiedRelationRole))
    BIND(BNODE() AS ?qualifiedRelation)
  }

  OPTIONAL {
    ?res field:contributorNames ?contributorName .
    BIND(IRI(CONCAT("https://catalogue.org/contact/", ENCODE_FOR_URI(STR(?contributorName)))) AS ?attributionAgent)
    BIND(?contributorName AS ?attributionAgentName)
  }
  OPTIONAL { ?res field:contributorRoleUris ?contributorRoleUri . BIND(IRI(STR(?contributorRoleUri)) AS ?attributionRole) }
  OPTIONAL { ?res field:contributorDescriptions ?attributionDescription . }
  OPTIONAL {
    FILTER(BOUND(?attributionAgent) || BOUND(?attributionRole))
    BIND(BNODE() AS ?attribution)
  }

  BIND(?res AS ?dataset)
  OPTIONAL {
    ?res field:typeNames ?typeName .
    FILTER(REGEX(LCASE(STR(?typeName)), "network|catalog"))
    BIND(?res AS ?catalog)
  }
  OPTIONAL {
    ?res field:typeNames ?typeNameService .
    FILTER(REGEX(LCASE(STR(?typeNameService)), "service|datasource"))
    BIND(?res AS ?service)
  }
  OPTIONAL {
    ?res field:typeNames ?typeNameSeries .
    FILTER(REGEX(LCASE(STR(?typeNameSeries)), "series|datasource"))
    BIND(IRI(CONCAT("https://catalogue.org/series/", ENCODE_FOR_URI(STR(?res)))) AS ?series)
  }

  OPTIONAL { ?res field:endpointUrl ?endpointUrl . BIND(IRI(STR(?endpointUrl)) AS ?endpointUrlIri) }
  OPTIONAL { ?res field:downloadUrl ?downloadUrl . BIND(IRI(STR(?downloadUrl)) AS ?downloadUrlIri) }
  OPTIONAL { ?res field:accessService ?accessServiceRaw . BIND(IRI(STR(?accessServiceRaw)) AS ?accessService) }
  OPTIONAL { ?res field:servesDataset ?servesDatasetRaw . BIND(IRI(STR(?servesDatasetRaw)) AS ?servesDataset) }

  OPTIONAL { ?res field:format ?formatRaw . BIND(IRI(STR(?formatRaw)) AS ?formatIri) }
  OPTIONAL { ?res field:mediaType ?mediaTypeRaw . BIND(IRI(STR(?mediaTypeRaw)) AS ?mediaTypeIri) }
  OPTIONAL { ?res field:packageFormat ?packageFormatRaw . BIND(IRI(STR(?packageFormatRaw)) AS ?packageFormatIri) }
  OPTIONAL { ?res field:compressFormat ?compressFormatRaw . BIND(IRI(STR(?compressFormatRaw)) AS ?compressFormatIri) }
  OPTIONAL { ?res field:checksum ?checksumValue . }

  OPTIONAL {
    ?res field:documentationUrls ?recordUrl .
    BIND(IRI(STR(?recordUrl)) AS ?record)
    BIND(?res AS ?recordTopic)
  }
  OPTIONAL { ?res field:recordIssued ?recordIssued . }
  OPTIONAL { ?res field:recordModified ?recordModified . }

  OPTIONAL {
    ?res field:relationshipRelation ?relationshipRelationRaw .
    BIND(IRI(STR(?relationshipRelationRaw)) AS ?relationshipRelation)
  }
  OPTIONAL { ?res field:relationshipRole ?relationshipRoleRaw . BIND(IRI(STR(?relationshipRoleRaw)) AS ?relationshipRole) }
  OPTIONAL {
    FILTER(BOUND(?relationshipRelation) || BOUND(?relationshipRole))
    BIND(BNODE() AS ?relationship)
  }

  OPTIONAL { ?res field:catalog ?catalogRaw . BIND(IRI(STR(?catalogRaw)) AS ?catalogIri) }
  OPTIONAL { ?res field:catalogDataset ?catalogDatasetRaw . BIND(IRI(STR(?catalogDatasetRaw)) AS ?catalogDataset) }
  OPTIONAL { ?res field:catalogRecord ?catalogRecordRaw . BIND(IRI(STR(?catalogRecordRaw)) AS ?catalogRecord) }
  OPTIONAL { ?res field:catalogResource ?catalogResourceRaw . BIND(IRI(STR(?catalogResourceRaw)) AS ?catalogResource) }
  OPTIONAL { ?res field:catalogService ?catalogServiceRaw . BIND(IRI(STR(?catalogServiceRaw)) AS ?catalogService) }
  OPTIONAL { ?res field:themeTaxonomy ?themeTaxonomyRaw . BIND(IRI(STR(?themeTaxonomyRaw)) AS ?themeTaxonomy) }

  OPTIONAL { ?res field:wasGeneratedBy ?wasGeneratedByRaw . BIND(IRI(STR(?wasGeneratedByRaw)) AS ?wasGeneratedBy) }
}
